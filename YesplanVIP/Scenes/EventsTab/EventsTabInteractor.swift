//
//  EventsTabInteractor.swift
//  YesplanVIP
//
//  Created by Techcc - FOH - Video on 22/08/18.
//  Copyright (c) 2018 Yesplan. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit
import ws
import then

protocol EventsTabBusinessLogic
{
  func doSomething(request: EventsTab.Something.Request) // -> Promise<EventsTab.Something.Response>
//     var basic: Basic? { get set }
}

protocol EventsTabDataStore
{
}

class EventsTabInteractor: EventsTabBusinessLogic, EventsTabDataStore
{
  var presenter: EventsTabPresentationLogic?
  var worker: EventsTabWorker?
    
    var fetchedEvents: Events = Events()
    var fetchedStatuses: Statuses = Statuses()
    var fetchedProfiles: Profiles = Profiles()
    
    var eventsArray: [(key: String, value: [Event])] = [(key: String, value: [Event])]()
    var statusesArray: [Status] = [Status]()
    var profilesArray: [Profile] = [Profile]()
    
    var yesplan: Yesplan = Yesplan()
    
  // MARK: Do something

  func doSomething(request: EventsTab.Something.Request) // -> Promise<EventsTab.Something.Response>
  {
    worker = EventsTabWorker()


    yesplan.getAll(fetchedEvents, query: "event:date:#thisweek")
        
//        .then {
//            [weak self] response in
//            guard let s = self else { return }
//            s.fetchedEvents = response
//            }
//        .then((worker?.printFetchedEvents)!)
        .then((worker?.groupEventsByStartdate)!)
//        .then((worker?.printGroupedEventsByStartdate)!)
        .then((worker?.sortEventsInEachGroupByTime)!)
//        .then((worker?.printsortedEventsInEachGroupByTime)!)
        .then((worker?.sortDictByDate)!)
        .then { result in
            self.eventsArray = result
        }
    
        .then(yesplan.getAll(fetchedStatuses))
//            .then((worker?.printStatuses)!)
        .then { result in
            self.statusesArray = result.data
        }
        
        .then(yesplan.getAll(fetchedProfiles))
//            .then((worker?.printProfiles)!)
        .then { result in
            self.profilesArray = result.data
        }
        
        .onError((worker?.showErrorPopup)!)

        .finally {
     
        let response = EventsTab.Something.Response(
            events: self.eventsArray,
            statuses: self.statusesArray,
            profiles: self.profilesArray
        )
        self.presenter?.presentEvents(response: response)
    }

//                print("pagination: ", s.fetchedEvents.pagination )
//                s.yesplan.getMore(s.fetchedEvents, paginationNext: s.fetchedEvents.pagination.next!).then { more in
//                    print("more", more.pagination)
//                }

  }
}
