//
//  TeamplannerInteractor.swift
//  YesplanVIP
//
//  Created by Techcc - FOH - Video on 13/08/18.
//  Copyright (c) 2018 Yesplan. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit
import PromiseKit

protocol TeamplannerTabBusinessLogic
{
  func doSomething(request: TeamplannerTab.Something.Request)
}

protocol TeamplannerTabDataStore
{
  //var name: String { get set }
}

class TeamplannerTabInteractor: TeamplannerTabBusinessLogic, TeamplannerTabDataStore
{
    var presenter: TeamplannerTabPresentationLogic?
    var worker: TeamplannerTabWorker?
    var dict: [[String? : [Schedules]]] = []
  
  // MARK: Do something
  
  func doSomething(request: TeamplannerTab.Something.Request)
  {
    worker = TeamplannerTabWorker()
   
    let path = "resource:name:\(String(describing: UserDefaults.standard.string(forKey: "todo_user")!))"
    var queryItems = [String:String]()
    queryItems = ["from": request.startdate, "to" : request.enddate]

    worker?.getResourcesSchedules(path: path, query: queryItems)
//    .tap { items in
//        print("items: ", items) }
            .map { $0.data
            } .get { fromTos in
                self.dict = fromTos.compactMap { [$0.resource.name : $0.schedules]}
            }.tap { result in print("r", result)
            }.flatMapValues { item  in return item.schedules.compactMap { $0.id }
//            }.tap { result in print("2", result)
            }.thenMap { item -> Promise<Resourcebooking> in (self.worker?.getResourcebookingId(item)!)!
//            }.tap { result in print("3", result)
            }.done { result in
//                print("result:", result)
                let response = TeamplannerTab.Something.Response(
                    resourcebookings: result,
                    schedules: self.dict,
                    error: nil
                )
                self.presenter?.presentSomething(response: response)

            }.catch { error in
                let alert = UIAlertController(title: "Error", message: error.localizedDescription, preferredStyle: .alert)
                alert.addAction(UIAlertAction(title: "Dismiss", style: .default, handler: nil))
//                self.present(alert, animated: true, completion: nil)
        }
    }
}
